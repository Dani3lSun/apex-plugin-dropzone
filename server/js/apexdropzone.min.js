var apexDropzone={parseBoolean:function(e){var o;return"true"==e.toLowerCase()&&(o=!0),"false"==e.toLowerCase()&&(o=!1),"true"!=e.toLowerCase()&&"false"!=e.toLowerCase()&&(o=void 0),o},imageExists:function(e,o,a){try{var r=new Image;r.onload=o,r.onerror=a,r.src=e}catch(e){apex.debug.log("apexDropzone.imageExists Error",e)}},clob2Array:function(e,o,a){loopCount=Math.floor(e.length/o)+1;for(var r=0;r<loopCount;r++)a.push(e.slice(o*r,o*(r+1)));return a},binaryArray2base64:function(e){for(var o="",a=new Uint8Array(e),r=a.byteLength,p=0;p<r;p++)o+=String.fromCharCode(a[p]);return btoa(o)},setUploadProgress:function(e,o,a){var r;e?(r=e.loaded/e.total*100,r>100&&(r=100),a.upload={progress:r,total:e.total,bytesSent:e.loaded}):(r=100,a.upload={progress:r,bytesSent:a.upload.total}),o.emit("uploadprogress",a,r,a.size/(100/r))},setUploadProgressChunked:function(e,o,a,r,p){var n;e?(n=a/r*100,n+=e.loaded/e.total*100/r,n>100&&(n=100),p.upload={progress:n,total:e.total*(a/r),bytesSent:e.loaded*(a/r)}):(n=100*(a/r),n>100&&(n=100),p.upload={progress:n,bytesSent:p.upload.total*(a/r)}),o.emit("uploadprogress",p,n,p.size/(100/n))},asyncLoop:function(e,o,a){var r=1,p=!1,n={next:function(){p||(r<=e?(r++,o(n)):(p=!0,a()))},iteration:function(){return r-1},stop:function(){p=!0,a()}};return n.next(),n},processFile:function(e,o,a){if((e.options.resizeWidth||e.options.resizeHeight)&&o.type.match(/image.*/)){var r=e.options.resizeMethod;r=e.options.resizeWidth&&e.options.resizeHeight?"crop":"contain",e.resizeImage(o,e.options.resizeWidth,e.options.resizeHeight,r,function(e){e.name=o.name,e.status=o.status,e.accepted=o.accepted,e.processing=o.processing,e.lastModified=o.lastModified,e.lastModifiedDate=o.lastModifiedDate,e.previewElement=o.previewElement,e.previewTemplate=o.previewTemplate,e._removeLink=o._removeLink,a(e)})}else a(o)},uploadDzFilesChunked:function(e,o,a,r,p){for(var n=0;n<r.length;n++){var l,t=r[n];apexDropzone.processFile(a,r[n],function(r){r&&(l=t,t=r);var n=new FileReader;n.onload=function(n){return function(s){if(n){var i,d,u,g,c,x=p||1048576,z=Math.ceil(t.size/x);apexDropzone.asyncLoop(z,function(p){u=p.iteration(),g=x*(u-1),c=g+x,apex.debug.log(t.name+" currentChunk",u),apex.debug.log(t.name+" chunkStart",g),apex.debug.log(t.name+" chunkEnd",c),i=t.slice(g,c);var n=new FileReader;n.onload=function(n){return function(n){d=apexDropzone.binaryArray2base64(n.target.result);var s=[];s=apexDropzone.clob2Array(d,3e4,s),t.xhr=apex.jQuery.ajax({dataType:"text",type:"POST",url:window.location.href.substr(0,window.location.href.indexOf("/f?p=")+1)+"wwv_flow.show",async:!0,traditional:!0,data:{x01:"UPLOAD",x02:t.name,x03:t.type,x04:u,x05:z,f01:s,p_request:"PLUGIN="+o,p_flow_id:$v("pFlowId"),p_flow_step_id:$v("pFlowStepId"),p_instance:$v("pInstance"),p_debug:$v("pdebug")},success:function(o){r&&(t=l);var n;try{n=jQuery.parseJSON(o)}catch(e){apex.debug.log("apexDropzone.uploadDzFilesChunked Response ParseError",e),n=jQuery.parseJSON('{ "status": "error", "message": "uploadDzFilesChunked Response ParseError", "code": "AJAX Callback (pData) ParseError" }')}"error"==n.status?(apex.debug.log("apexDropzone.uploadDzFilesChunked Error",n.message,n.code),apex.event.trigger("#"+e,"dropzone-upload-chunk-error",n),t.status=Dropzone.ERROR,a.emit("error",t,"Database error during file upload"),a.emit("complete",t),a.processQueue()):"success"==n.status&&(apex.debug.log("apexDropzone.uploadDzFilesChunked Success",n.message),apex.event.trigger("#"+e,"dropzone-upload-chunk-success",o),u==z&&(t.id=n.id,t.status=Dropzone.SUCCESS,a.emit("success",t,"success",null),a.emit("complete",t),a.processQueue())),r&&(t=r),p.next()},error:function(o,p){r&&(t=l),apex.debug.log("apexDropzone.uploadDzFilesChunked Error",p),apex.event.trigger("#"+e,"dropzone-upload-chunk-error",p),t.status=Dropzone.ERROR;var n="";n=p?p:"Error processing file",a.emit("error",t,n,o),a.emit("complete",t),a.processQueue()},xhr:function(){return XhrObj=$.ajaxSettings.xhr(),XhrObj.upload?XhrObj.upload.addEventListener("progress",function(e){apexDropzone.setUploadProgressChunked(e,a,u,z,l||t)},!1):apex.debug.log("apexDropzone.uploadDzFilesChunked XHR","Upload progress is not supported."),XhrObj}})}}(i),n.readAsArrayBuffer(i)},function(){apex.debug.log("apexDropzone.uploadDzFilesChunked Loop ended")})}else a.processQueue()}}(t),n.readAsArrayBuffer(t)})}},uploadDzFilesFormData:function(e,o,a,r){for(var p=0;p<r.length;p++){var n,l=r[p];apexDropzone.processFile(a,r[p],function(r){if(r&&(n=l,l=r),l){var p=new FormData;p.append("p_request","PLUGIN="+o),p.append("p_flow_id",$v("pFlowId")),p.append("p_flow_step_id",$v("pFlowStepId")),p.append("p_instance",$v("pInstance")),p.append("p_debug",$v("pdebug")),p.append("F01",l,l.name),p.append("X01","UPLOAD"),p.append("X02",l.name),p.append("X03",l.type),a.emit("uploadprogress",l,10,l.size/10),l.xhr=apex.jQuery.ajax({dataType:"text",type:"POST",url:window.location.href.substr(0,window.location.href.indexOf("/f?p=")+1)+"wwv_flow.show",async:!0,processData:!1,contentType:!1,traditional:!0,data:p,success:function(o){r&&(l=n);var p;try{p=jQuery.parseJSON(o)}catch(e){apex.debug.log("apexDropzone.uploadDzFiles Response ParseError",e),p=jQuery.parseJSON('{ "status": "error", "message": "uploadDzFiles Response ParseError", "code": "AJAX Callback (pData) ParseError" }')}"error"==p.status?(apex.debug.log("apexDropzone.uploadDzFiles Error",p.message,p.code),apex.event.trigger("#"+e,"dropzone-upload-error",p),l.status=Dropzone.ERROR,a.emit("error",l,"Database error during file upload")):"success"==p.status&&(l.id=p.id,apex.debug.log("apexDropzone.uploadDzFiles Success",p.message),apex.event.trigger("#"+e,"dropzone-upload-success",o),l.status=Dropzone.SUCCESS,a.emit("success",l,"success",null)),a.emit("uploadprogress",l,100,l.size),a.emit("complete",l),r&&(l=r),a.processQueue()},error:function(o,p){r&&(l=n),apex.debug.log("apexDropzone.uploadDzFiles Error",p),apex.event.trigger("#"+e,"dropzone-upload-error",p),l.status=Dropzone.ERROR;var t="";t=p?p:"Error processing file",a.emit("error",l,t,o),a.emit("complete",l),a.processQueue()},xhr:function(){return XhrObj=$.ajaxSettings.xhr(),XhrObj.upload?XhrObj.upload.addEventListener("progress",function(e){apexDropzone.setUploadProgress(e,a,l)},!1):apex.debug.log("apexDropzone.uploadDzFiles XHR","Upload progress is not supported."),XhrObj}})}else a.processQueue()})}},deleteDzFile:function(e,o,a,r){apex.jQuery.ajax({dataType:"text",type:"POST",url:window.location.href.substr(0,window.location.href.indexOf("/f?p=")+1)+"wwv_flow.show",async:!0,traditional:!0,data:{x01:"DELETE",x02:r.name,x03:r.id,p_request:"PLUGIN="+o,p_flow_id:$v("pFlowId"),p_flow_step_id:$v("pFlowStepId"),p_instance:$v("pInstance"),p_debug:$v("pdebug")},success:function(o){var a;try{a=jQuery.parseJSON(o)}catch(e){apex.debug.log("apexDropzone.deleteDzFile Response ParseError",e),a=jQuery.parseJSON('{ "status": "error", "message": "deleteDzFile Response ParseError", "code": "AJAX Callback (pData) ParseError" }')}"error"==a.status?(apex.debug.log("apexDropzone.deleteDzFile Error",a.message,a.code),apex.event.trigger("#"+e,"dropzone-delete-error",a)):"success"==a.status&&(apex.debug.log("apexDropzone.deleteDzFile Success",a.message),apex.event.trigger("#"+e,"dropzone-delete-success",o))},error:function(o,a){apex.debug.log("apexDropzone.deleteDzFile Error",a),apex.event.trigger("#"+e,"dropzone-delete-error",a)}})},handlePluginEvents:function(e,o){e.on("removedfile",function(e){apex.debug.log("apexDropzone.handlePluginEvents - removedfile event"),apex.event.trigger("#"+o,"dropzone-deleted-file",e)}),e.on("addedfile",function(e){apex.debug.log("apexDropzone.handlePluginEvents - addedfile event"),apex.event.trigger("#"+o,"dropzone-added-file",e)}),e.on("maxfilesexceeded",function(e){apex.debug.log("apexDropzone.handlePluginEvents - maxfilesexceeded event"),apex.event.trigger("#"+o,"dropzone-maxfiles-exceeded",e)}),e.on("totaluploadprogress",function(e){apex.debug.log("apexDropzone.handlePluginEvents - totaluploadprogress event"),apex.event.trigger("#"+o,"dropzone-totalupload-progress",e)}),e.on("dragenter",function(){apex.debug.log("apexDropzone.handlePluginEvents - dragenter event"),apex.event.trigger("#"+o,"dropzone-drag-over")}),e.on("error",function(e,a){apex.debug.log("apexDropzone.handlePluginEvents - error event"),e.errorMessage=a,apex.event.trigger("#"+o,"dropzone-file-error",e)}),e.on("complete",function(){0===e.getQueuedFiles().length&&0===e.getUploadingFiles().length&&(apex.debug.log("apexDropzone.handlePluginEvents - complete event"),apex.event.trigger("#"+o,"dropzone-upload-complete"))})},pluginHandler:function(e,o){var a=jQuery("#"+apex.util.escapeCSS(e+"_dropzone"),apex.gPageContext$),r=apex.util.escapeCSS(e+"_dropzone"),p=o.ajaxIdentifier,n=parseFloat(o.maxFilesize),l=parseInt(o.maxFiles),t=o.acceptedFiles,s=o.uploadMechanism,i=apexDropzone.parseBoolean(o.clickable),d=apexDropzone.parseBoolean(o.showFilePreview),u=apexDropzone.parseBoolean(o.supportCopyPaste),g=apexDropzone.parseBoolean(o.removeAfterUpload),c=apexDropzone.parseBoolean(o.deleteFiles),x=apexDropzone.parseBoolean(o.resizeImages),z=parseInt(o.resizeWidth),f=parseInt(o.resizeHeight),D=o.pluginPrefix,v=parseInt(o.chunkSize),m=o.displayMessage,b=o.fallbackMessage,h=o.fileTooBigMessage,F=o.maxFilesMessage,w=o.removeFileMessage,y=o.cancelUploadMessage,E=o.cancelUploadConfirmMessage,P=o.invalidFileTypeMessage;apex.debug.log("apexDropzone.pluginHandler - pRegionId",e),apex.debug.log("apexDropzone.pluginHandler - pOptions",o),apex.debug.log("apexDropzone.pluginHandler - region",r),apex.debug.log("apexDropzone.pluginHandler - region$",a),apex.debug.log("apexDropzone.pluginHandler - ajaxIdentifier",p),apex.debug.log("apexDropzone.pluginHandler - maxFileSize",n),apex.debug.log("apexDropzone.pluginHandler - maxFiles",l),apex.debug.log("apexDropzone.pluginHandler - acceptedFiles",t),apex.debug.log("apexDropzone.pluginHandler - uploadMechanism",s),apex.debug.log("apexDropzone.pluginHandler - clickable",i),apex.debug.log("apexDropzone.pluginHandler - showFilePreview",d),apex.debug.log("apexDropzone.pluginHandler - supportCopyPaste",u),apex.debug.log("apexDropzone.pluginHandler - removeAfterUpload",g),apex.debug.log("apexDropzone.pluginHandler - deleteFiles",c),apex.debug.log("apexDropzone.pluginHandler - resizeImages",x),apex.debug.log("apexDropzone.pluginHandler - resizeWidth",z),apex.debug.log("apexDropzone.pluginHandler - resizeHeight",f),apex.debug.log("apexDropzone.pluginHandler - pluginPrefix",D),apex.debug.log("apexDropzone.pluginHandler - chunkSize",v),apex.debug.log("apexDropzone.pluginHandler - displayMessage",m),apex.debug.log("apexDropzone.pluginHandler - fallbackMessage",b),apex.debug.log("apexDropzone.pluginHandler - fileTooBigMessage",h),apex.debug.log("apexDropzone.pluginHandler - maxFilesMessage",F),apex.debug.log("apexDropzone.pluginHandler - removeFileMessage",w),apex.debug.log("apexDropzone.pluginHandler - cancelUploadMessage",y),apex.debug.log("apexDropzone.pluginHandler - cancelUploadConfirmMessage",E),apex.debug.log("apexDropzone.pluginHandler - invalidFileTypeMessage",P);var C,H;x?(C=z||null,H=f||null):(C=null,H=null);var S={url:window.location.href.substr(0,window.location.href.indexOf("/f?p=")+1)+"wwv_flow.show",uploadMultiple:!1,autoProcessQueue:!0,parallelUploads:1,addRemoveLinks:c,maxFilesize:n,clickable:i,maxFiles:l,acceptedFiles:t,resizeWidth:C,resizeHeight:H,dictDefaultMessage:m,dictFallbackMessage:b,dictFileTooBig:h,dictMaxFilesExceeded:F,dictRemoveFile:w,dictCancelUpload:y,dictCancelUploadConfirmation:E,dictInvalidFileType:P};Dropzone.autoDiscover=!1;var _=new Dropzone("div#"+r,S);i||$(".dz-hidden-input").prop("disabled",!0),u&&FileReaderJS.setupClipboard(document.body,{readAsDefault:"DataURL",accept:{"image/*":"DataURL"},on:{load:function(e,o){_.addFile(o)}}}),_.uploadFiles=function(o){"NORMAL"==s?apexDropzone.uploadDzFilesFormData(e,p,_,o):"CHUNKED"==s&&apexDropzone.uploadDzFilesChunked(e,p,_,o,v)},apexDropzone.handlePluginEvents(_,e),c&&_.on("removedfile",function(o){"success"==o.status&&apexDropzone.deleteDzFile(e,p,_,o)}),_.on("addedfile",function(e){if(d&&!e.type.match(/image.*/)){var a=e.name.split(".").pop(),r=o.pluginPrefix+"img/"+a+".png";apexDropzone.imageExists(r,function(){$(e.previewElement).find(".dz-image img").attr("src",o.pluginPrefix+"img/"+a+".png")},function(){$(e.previewElement).find(".dz-image img").attr("src",o.pluginPrefix+"img/other.png")})}}),_.on("complete",function(){0===_.getQueuedFiles().length&&0===_.getUploadingFiles().length&&g&&setTimeout(function(){_.removeAllFiles()},3e3)})}};